<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>WebSSH Cluster // MANAGER</title>
    <link href="static/img/favicon-32.png" rel="icon" type="image/png">
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-color: #050510;
            --panel-bg: rgba(20, 20, 30, 0.8);
            --primary-cyan: #00f3ff;
            --alert-red: #ff2a2a;
            --neon-green: #00ff41;
            --text-main: #e0e0e0;
            --text-dim: #8892b0;
            --border-glow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            /* 代码风格字体 */
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            /* 网格背景 */
            color: var(--text-main);
            min-height: 100vh;
        }

        /* 扫描线效果 */
        body::before {
            content: " ";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 9999;
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-cyan);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px var(--primary-cyan);
            margin: 0;
        }

        /* HUD 风格卡片 */
        .node-card {
            background: var(--panel-bg);
            border: 1px solid rgba(0, 243, 255, 0.3);
            border-left: 4px solid var(--primary-cyan);
            /* 左侧强调色 */
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 98% 100%, 0 100%);
            /* 切角效果 */
            transition: all 0.3s ease;
        }

        .node-card:hover {
            box-shadow: var(--border-glow);
            border-color: var(--primary-cyan);
        }

        .node-info h3 {
            margin: 0 0 15px 0;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .stats {
            display: flex;
            gap: 30px;
            color: var(--text-dim);
            font-size: 0.85em;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item strong {
            color: var(--primary-cyan);
            font-size: 1.1em;
            display: block;
            margin-top: 4px;
        }

        /* 按钮与链接 */
        .actions a,
        button,
        .login-btn {
            text-decoration: none;
            background: rgba(0, 243, 255, 0.1) !important;
            color: var(--primary-cyan) !important;
            border: 1px solid var(--primary-cyan) !important;
            padding: 8px 20px;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 243, 255, 0.2);
            font-family: 'Orbitron', sans-serif;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            border-radius: 0 !important;
        }

        .actions a:hover,
        button:hover,
        .login-btn:hover {
            background: var(--primary-cyan) !important;
            color: #000 !important;
            box-shadow: 0 0 20px var(--primary-cyan);
        }

        /* 状态指示灯 */
        .status-dot {
            height: 8px;
            width: 8px;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 8px currentColor;
        }

        .online {
            background-color: var(--neon-green);
            color: var(--neon-green);
        }

        .offline {
            background-color: var(--alert-red);
            color: var(--alert-red);
        }

        /* Master Status */
        #master-status {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(0, 0, 0, 0.6) !important;
            border: 1px solid var(--text-dim);
            color: var(--text-main) !important;
            box-shadow: none !important;
            border-radius: 0 !important;
        }

        /* Modal */
        .modal-content {
            background-color: #0a0a12;
            border: 1px solid var(--primary-cyan);
            color: var(--text-main);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
            border-radius: 0;
        }

        .modal h2 {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-cyan);
            border-bottom: 1px solid rgba(0, 243, 255, 0.3);
            padding-bottom: 10px;
        }

        input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #333;
            color: var(--primary-cyan);
            font-family: 'JetBrains Mono', monospace;
            padding: 10px;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        /* Tabs */
        .tabs {
            border-bottom: 1px solid rgba(0, 243, 255, 0.3);
        }

        .tab-btn {
            color: var(--text-dim);
            font-family: 'Orbitron', sans-serif;
            border-radius: 0;
        }

        .tab-btn.active {
            color: var(--primary-cyan);
            border-bottom: 3px solid var(--primary-cyan);
            text-shadow: 0 0 8px var(--primary-cyan);
        }

        .tab-btn:hover {
            background: rgba(0, 243, 255, 0.05);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 30px;
            gap: 15px;
            border-bottom: 1px solid rgba(0, 243, 255, 0.1);
            padding-bottom: 10px;
        }

        .toolbar-btn {
            color: var(--text-main);
        }

        .toolbar-btn:hover {
            color: var(--primary-cyan);
            text-shadow: 0 0 5px var(--primary-cyan);
        }

        /* Grid Layout Override */
        /* Grid Layout Override */
        #node-list.grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        #node-list.grid .node-card {
            flex-direction: column;
            align-items: flex-start;
            border-top: 2px solid var(--primary-cyan);
            border-left: 1px solid rgba(0, 243, 255, 0.3);
        }

        #node-list.grid .node-info {
            width: 100%;
        }

        #node-list.grid .stats {
            flex-direction: row;
            flex-wrap: wrap;
        }

        #node-list.grid .actions {
            width: 100%;
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div
            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 30px; border-bottom: 1px solid rgba(0,243,255,0.2); padding-bottom: 20px;">
            <div style="display: flex; flex-direction: column; gap: 5px;">
                <h1>Cluster // DASHBOARD</h1>
                <div id="auth-controls" style="font-size: 0.8em; color: var(--text-dim);"></div>
            </div>

            <div id="master-status"
                style="font-size: 0.8rem; display: flex; flex-direction: column; gap: 5px; padding: 10px; border: 1px solid var(--primary-cyan); align-items: flex-end;">
            </div>
        </div>

        <!-- REPLACED TABS WITH SIMPLE SPACER -->
        <div style="margin-top: 20px;"></div>

        <!-- AUTH REQUIRED BLOCK (Login Form) -->
        <div id="guestOverlay" class="node-card"
            style="border-color: var(--alert-red); flex-direction: column; text-align: center; margin-bottom: 30px; background: rgba(255, 42, 42, 0.05);">
            <h2
                style="color: var(--alert-red); border-bottom: 1px solid var(--alert-red); padding-bottom: 10px; width: 100%; font-family: 'Orbitron', sans-serif; margin-top: 0;">
                ACCESS REQUIRED
            </h2>
            <p style="color: var(--text-main); margin: 20px 0;">SYSTEM LOCKED. ENTER SECURITY KEY TO UNLOCK CONTROL.</p>
            <div style="width: 100%; max-width: 400px; margin: 0 auto;">
                <input type="password" id="passwordInput" placeholder="ENTER SECURITY KEY"
                    style="width: 100%; margin-bottom: 15px; box-sizing: border-box; text-align: center;"
                    onkeypress="handleEnter(event)">
                <button class="login-btn" onclick="performLogin()"
                    style="border-color: var(--alert-red)!important; color: var(--alert-red)!important; width: 100%;">AUTHENTICATE</button>
            </div>
            <p id="loginError" style="color: var(--alert-red); display: none; margin-top: 10px; font-size: 0.8em;"></p>
        </div>


        <div id="tab-cluster" class="tab-content active" style="margin-top: 20px;">
            <div class="toolbar">
                <button class="toolbar-btn" onclick="toggleView()" title="View Mode"><span id="view-icon">≣</span>
                    VIEW</button>
                <button class="toolbar-btn" onclick="toggleSort()" title="Sort Order"><span id="sort-icon">⬇️</span>
                    SORT</button>
            </div>
            <div id="node-list">
                <p style="color: var(--primary-cyan); animation: blink 1s infinite;">INITIALIZING CONNECTION...</p>
            </div>
        </div>
    </div>



    <script>
        const CLUSTER_SECRET = "{{ secret }}";
        const IS_AUTHED = "{{ is_authed }}" == "True";

        // Ensure XSRF cookie is set and available for JS
        const REQUEST_XSRF_TOKEN = "{{ handler.xsrf_token }}";

        let currentSort = 'asc'; // 'asc' or 'desc'
        let currentView = 'list'; // 'list' or 'grid'
        let lastNodes = []; // store for re-rendering

        function connect(url) {
            let targetUrl = url;
            if (CLUSTER_SECRET) {
                targetUrl += (targetUrl.includes('?') ? '&' : '?') + 'secret=' + encodeURIComponent(CLUSTER_SECRET);
            }
            window.open(targetUrl, '_blank');
        }


        // --- Tab Logic ---
        async function switchTab(tab, event) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById('tab-' + tab).classList.add('active');
            if (event) {
                event.currentTarget.classList.add('active');
            } else {
                const index = ['cluster'].indexOf(tab);
                if (index >= 0) document.querySelectorAll('.tab-btn')[index].classList.add('active');
            }
        }

        // --- Auth & Main Logic ---
        function initAuthUI() {
            const container = document.getElementById('auth-controls');
            // Style overridden by CSS via class logic below, simplified HTML here
            if (IS_AUTHED) {
                container.innerHTML = `
                    <span style="color: var(--neon-green)" onclick="connect('/webssh')">[ ACCESS GRANTED ]</span>
                `;
                document.getElementById('guestOverlay').style.display = 'none';
            } else {
                container.innerHTML = `<span style="color: var(--alert-red)">[ ACCESS LOCKED ]</span>`;
                if (document.cookie.indexOf('XSRF') === -1) {
                    // Initial load might not have cookie set yet?
                }
                // Only show overlay if we want to force login, user said "remove login button" implies 
                // maybe they want it always visible or moved. 
                // Request: "remove LOGIN_SYSTEM button, move ACCESS REQUIRED to top"
                // Let's hide the overlay by default and only show login modal when triggered? 
                // Actually user said "move ACCESS REQUIRED to top". 
                // Maybe they mean the login modal itself?
                // Or just the "dashboard title"? 
                // Interpreting "ACCESS REQUIRED moved to top" as a status indicator.
                // The Guest Overlay is a good way to "force" the attention or maybe just a header bar.
            }
        }

        function openLogin() {
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('passwordInput').focus();
        }
        function closeLogin() { document.getElementById('loginModal').style.display = 'none'; }

        function handleEnter(e) {
            if (e.key === 'Enter') performLogin();
        }

        async function performLogin() {
            const pwd = document.getElementById('passwordInput').value;
            const err = document.getElementById('loginError');
            err.style.display = 'none';

            try {
                // Get XSRF token
                const headers = { 'Content-Type': 'application/json' };
                if (REQUEST_XSRF_TOKEN) headers['X-XSRFToken'] = REQUEST_XSRF_TOKEN;

                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({ password: pwd })
                });
                if (res.ok) {
                    window.location.reload();
                } else {
                    let errorMsg = "Invalid Password";
                    try {
                        const data = await res.json();
                        if (data.error) errorMsg = data.error;
                    } catch (e) {
                        errorMsg = "Login Failed (" + res.status + " " + res.statusText + ")";
                    }
                    err.textContent = "Error: " + errorMsg;
                    err.style.display = 'block';
                }
            } catch (e) {
                err.textContent = "System Error: " + e;
                err.style.display = 'block';
            }
        }

        function getCookie(name) {
            var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
            return r ? r[1] : undefined;
        }

        function toggleSort() {
            currentSort = currentSort === 'asc' ? 'desc' : 'asc';
            document.getElementById('sort-icon').textContent = currentSort === 'asc' ? '⬇️' : '⬆️';
            fetchNodes();
        }

        function toggleView() {
            currentView = currentView === 'list' ? 'grid' : 'list';
            document.getElementById('view-icon').textContent = currentView === 'list' ? '≣' : '⊞';
            const container = document.getElementById('node-list');
            if (currentView === 'grid') container.classList.add('grid');
            else container.classList.remove('grid');
        }

        async function fetchNodes() {
            try {
                const response = await fetch('/api/nodes');
                if (!response.ok) {
                    if (response.status === 401 && IS_AUTHED) window.location.reload();
                    throw new Error('Failed to fetch');
                }
                const nodes = await response.json();
                lastNodes = nodes; // Save for re-renders
                renderNodes(nodes);
            } catch (e) {
                console.error(e);
            }
        }

        async function controlApp(nodeId, action, pmId) {
            if (!confirm(`CONFIRM: ${action.toUpperCase()} process ${pmId}?`)) return;

            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-XSRFToken': REQUEST_XSRF_TOKEN
                    },
                    body: JSON.stringify({ node_id: nodeId, action: action, pm_id: pmId })
                });
                const data = await response.json();
                if (data.status === 'ok') {
                    alert(`COMMAND QUEUED: ${action.toUpperCase()}`);
                } else {
                    alert(`ERROR: ${data.error}`);
                }
            } catch (e) {
                alert(`COMM ERROR: ${e}`);
            }
        }

        function renderNodes(nodes) {
            const container = document.getElementById('node-list');
            const masterStatusDiv = document.getElementById('master-status');

            // Apply View State
            if (currentView === 'grid') container.classList.add('grid');
            else container.classList.remove('grid');

            // Extract Master-Local logic
            const masterNodeIndex = nodes.findIndex(n => n.name === 'Master-Local');
            if (masterNodeIndex > -1) {
                const master = nodes[masterNodeIndex];
                nodes.splice(masterNodeIndex, 1);
                const isOnline = master.is_online;
                masterStatusDiv.innerHTML = `
                        <span style="display: flex; align-items: center; margin-bottom: 5px;">
                            <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                            MASTER_NODE [${isOnline ? 'ONLINE' : 'OFFLINE'}]
                        </span>
                        <div style="text-align: right;">
                             <span style="color: var(--primary-cyan); margin-left: 10px;">CPU: <strong>${parseFloat(master.stats.cpu || 0).toFixed(1)}%</strong></span>
                             <span style="color: var(--primary-cyan); margin-left: 10px;">RAM: <strong>${(master.stats.ram_usage / 1024 / 1024).toFixed(0)} MB</strong></span>
                             <span style="color: var(--primary-cyan); margin-left: 10px;">DSK: <strong>${parseFloat(master.stats.disk_usage || 0).toFixed(0)}%</strong></span>
                             <span style="color: var(--primary-cyan); margin-left: 10px;">PROCS: <strong>${master.stats.processes || 0}</strong></span>
                        </div>
                `;
                masterStatusDiv.style.display = 'flex';
            } else {
                masterStatusDiv.style.display = 'none';
            }

            container.innerHTML = '';
            if (nodes.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim)">No slave units detected via network scan.</p>';
                return;
            }

            const grouped = {};
            nodes.forEach(node => {
                if (!grouped[node.name]) grouped[node.name] = [];
                grouped[node.name].push(node);
            });

            // Sort logic
            function extractNumber(name) {
                const match = name.match(/s(\d+)/i);
                if (match) return parseInt(match[1]);
                const anyNum = name.match(/(\d+)/);
                return anyNum ? parseInt(anyNum[1]) : 0;
            }

            let keys = Object.keys(grouped);
            keys.sort((a, b) => {
                const numA = extractNumber(a);
                const numB = extractNumber(b);

                if (numA !== numB) {
                    return currentSort === 'asc' ? numA - numB : numB - numA;
                }
                if (currentSort === 'asc') return a.localeCompare(b);
                else return b.localeCompare(a);
            });

            keys.forEach(name => {
                const groupNodes = grouped[name];
                const isAnyOnline = groupNodes.some(n => n.is_online);
                const username = groupNodes[0].username || 'N/A';

                let avgCpu = 0, totalRam = 0, maxDisk = 0, totalProcs = 0, onlineCount = 0;
                groupNodes.forEach(n => {
                    if (n.is_online) {
                        avgCpu += parseFloat(n.stats.cpu || 0);
                        totalRam += parseFloat(n.stats.ram_usage || 0);
                        maxDisk = Math.max(maxDisk, parseFloat(n.stats.disk_usage || 0));
                        totalProcs += parseInt(n.stats.processes || 0);
                        onlineCount++;
                    }
                });
                if (onlineCount > 0) avgCpu = avgCpu / onlineCount;

                // App List Rendering
                let appListHtml = '';
                if (isAnyOnline) {
                    // Collect apps from all online nodes in this group (usually just 1 for standalone/simple setup)
                    let apps = [];
                    groupNodes.forEach(n => {
                        if (n.stats && n.stats.pm2 && n.stats.pm2.length > 0) {
                            // Inject node_id into app object for control context
                            const nodeApps = n.stats.pm2.map(app => ({ ...app, nodeId: n.node_id }));
                            apps = apps.concat(nodeApps);
                        }
                    });

                    if (apps.length > 0) {
                        appListHtml = `
                             <div style="margin-top: 15px; border-top: 1px solid rgba(0, 243, 255, 0.2); paddingTop: 10px;">
                                 <h4 style="margin: 0 0 10px 0; font-size: 0.8em; color: var(--text-dim); letter-spacing: 1px;">// ACTIVE_APPLICATIONS</h4>
                                 <div style="display: flex; flex-direction: column; gap: 5px;">
                                     ${apps.map(app => `
                                         <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8em; background: rgba(0, 243, 255, 0.03); padding: 5px 8px; border-left: 2px solid ${app.status === 'online' ? 'var(--neon-green)' : 'var(--alert-red)'};">
                                             <div style="display:flex; flex-direction:column;">
                                                 <span style="color: var(--text-main); font-weight: bold;">${app.name} <span style="color: var(--text-dim);">[${app.id}]</span></span>
                                                 <div style="display: flex; gap: 10px; color: var(--text-dim); font-size: 0.9em;">
                                                     <span>${(app.memory / 1024 / 1024).toFixed(0)}MB</span>
                                                     <span style="color: ${app.status === 'online' ? 'var(--neon-green)' : 'var(--alert-red)'}">${app.status.toUpperCase()}</span>
                                                 </div>
                                             </div>
                                             
                                             ${IS_AUTHED ? `
                                             <div style="display: flex; gap: 5px;">
                                                 <button onclick="controlApp('${app.nodeId}', '${app.status === 'online' ? 'restart' : 'start'}', ${app.id})" 
                                                    style="background: transparent; border: 1px solid var(--primary-cyan); color: var(--primary-cyan); padding: 2px 5px; cursor: pointer; font-family: inherit; font-size: 0.8em;">
                                                    ${app.status === 'online' ? '↻' : '▶'}
                                                 </button>
                                                 <button onclick="controlApp('${app.nodeId}', 'stop', ${app.id})" 
                                                    style="background: transparent; border: 1px solid var(--alert-red); color: var(--alert-red); padding: 2px 5px; cursor: pointer; font-family: inherit; font-size: 0.8em;">
                                                    ■
                                                 </button>
                                             </div>
                                             ` : ''}
                                         </div>
                                     `).join('')}
                                 </div>
                             </div>
                         `;
                    }
                }

                const div = document.createElement('div');
                div.className = 'node-card';
                // Note: removed inline styles that clash with CSS, added cyberpunk structure
                div.innerHTML = `
                    <div class="node-info">
                        <h3>
                            <span class="status-dot ${isAnyOnline ? 'online' : 'offline'}"></span>
                            ${name} 
                            <span style="font-size: 0.6em; color: ${isAnyOnline ? 'var(--neon-green)' : 'var(--alert-red)'}; margin-left: 10px; border: 1px solid currentColor; padding: 2px 5px;">
                                ${onlineCount}/${groupNodes.length} ACTIVE
                            </span>
                        </h3>
                        <div class="stats">
                            <div class="stat-item"><span>AVG CPU</span> <strong>${avgCpu.toFixed(1)}%</strong></div>
                            <div class="stat-item"><span>RAM USE</span> <strong>${(totalRam / 1024 / 1024).toFixed(0)} MB</strong></div>
                            <div class="stat-item"><span>MAX DSK</span> <strong>${maxDisk.toFixed(0)}%</strong></div>
                            <div class="stat-item"><span>PROCS</span> <strong>${totalProcs}</strong></div>
                        </div>
                        ${appListHtml}
                    </div>
                    <div class="actions" style="display:flex; flex-direction:column; gap:8px;">
                        ${IS_AUTHED ? groupNodes.map(n => `
                            <a href="#" onclick="connect('${n.url}')">
                                [ CONNECT_UNIT: ${n.is_online ? 'READY' : 'LOST'} ]
                            </a>
                        `).join('') : '<span style="color:var(--text-dim); font-size:0.8em; font-style:italic;">[ GUEST MODE // READ ONLY ]</span>'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        initAuthUI();
        fetchNodes();
        setInterval(fetchNodes, 5000);
    </script>
</body>

</html>